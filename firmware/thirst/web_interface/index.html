<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<!--
		The above 3 meta tags *must* come first in the head. Any other head
		content must come *after* these tags.
		-->
		<title>Thirst | %PLANT_NAME%</title>

		<!-- CSS. -->
		<link href="css/bootstrap.min.css" rel="stylesheet" />
		<link href="css/custom.css" rel="stylesheet" />
		<link rel="shortcut icon" href="fav.png" />
	</head>

	<body>
		<!-- Modal-Error: Get config. -->
		<div
			role="dialog"
			tabindex="-1"
			data-backdrop="static"
			id="modal-error-get-config"
			class="modal fade bs-example-modal-lg"
			aria-labelledby="modal-error-get-config">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header modal-header-danger">
						<h4 class="modal-title">
							Error
						</h4>
					</div>
					<div class="modal-body">
						Failed to get config from the device.
					</div>
					<div class="modal-footer">
						<button
							type="button"
							data-dismiss="modal"
							class="btn btn-success"
							id="btn-modal-error-get-config-retry">
							Retry
						</button>
					</div>
				</div>
			</div>
		</div>

		<!--
		Modal-Warning: Save config.

		This modal is dynamic in nature as properties of this modal
		is dynamically updated based on current save procedure state.
		-->
		<div class="hidden" id="div-main">
			<div
				role="dialog"
				tabindex="-1"
				data-backdrop="static"
				id="modal-save-config"
				aria-labelledby="modal-save-config"
				class="modal fade bs-example-modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div
							class="modal-header"
							id="modal-save-config-header">
							<h4
								class="modal-title"
								id="modal-save-config-header-title">
								Information
							</h4>
						</div>
						<div class="modal-body" id="modal-save-config-body">
							Saving new config...
						</div>
						<div class="modal-footer">
							<button
								type="button"
								class="btn btn-success hidden"
								id="btn-modal-save-config-retry">
								Retry
							</button>
							<button
								hidden
								type="button"
								data-dismiss="modal"
								class="btn btn-default hidden"
								id="btn-modal-save-config-cancel">
								Cancel
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal-Error: Verification. -->
			<div
				tabindex="-1"
				role="dialog"
				data-backdrop="static"
				id="modal-error-verification-failed"
				class="modal fade bs-example-modal-lg"
				aria-labelledby="modal-error-verification-failed">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header modal-header-danger">
							<h4 class="modal-title">
								Error
							</h4>
						</div>
						<div class="modal-body">
							Verification failed. Please verify the marked fields.
						</div>
						<div class="modal-footer">
							<button
								class="btn btn-default"
								data-dismiss="modal"
								type="button">
								Close
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal-Information: About. -->
			<div
				tabindex="-1"
				role="dialog"
				data-backdrop="static"
				id="modal-infomation-about"
				class="modal fade bs-example-modal-lg"
				aria-labelledby="modal-infomation-about">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header modal-header-info">
							<h4 class="modal-title">
								About
							</h4>
						</div>
						<div class="modal-body">
							Thirst is a personal hobby project for fun. Current firmware version: v4.
						</div>
						<div class="modal-footer">
							<button
								type="button"
								data-dismiss="modal"
								class="btn btn-default">
								Close
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal-Information: WiFi Scan. -->
			<div
				tabindex="-1"
				role="dialog"
				data-backdrop="static"
				id="modal-information-wifi-scan"
				class="modal fade bs-example-modal-lg"
				aria-labelledby="modal-information-wifi-scan">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header modal-header-info">
							<h4 class="modal-title">
								Information
							</h4>
						</div>
						<div class="modal-body">
							Scanning for WiFi networks. Please wait...
						</div>
					</div>
				</div>
			</div>

			<!-- Modal-Error: WiFi scan. -->
			<div
				tabindex="-1"
				role="dialog"
				data-backdrop="static"
				id="modal-error-wifi-scan"
				aria-labelledby="modal-error-wifi-scan"
				class="modal fade bs-example-modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header modal-header-danger">
							<h4 class="modal-title">
								Error
							</h4>
						</div>
						<div class="modal-body">
							WiFi scan failed.
						</div>
						<div class="modal-footer">
							<button
								type="button"
								data-dismiss="modal"
								class="btn btn-default">
								Close
							</button>
						</div>
					</div>
				</div>
			</div>

			<br/>
			<br/>

			<div id="container-main" class="container container-fluid">
				<!-- Config form. -->
				<form id="form-config" class="form-horizontal">
					<div class="panel panel-default">
						<div class="panel-heading">
							<span
								class="glyphicon glyphicon-grain"
								style="font-size:1.5em;">
							</span>
							&nbsp;&nbsp;<font size="3">
											The Plant
										</font>
						</div>
						<div class="panel-body">
							<div class="row form-group">
								<label
									for="plant-name"
									class="col-sm-3 control-label">
									Plant Name:
								</label>
								<div class="col-sm-7">
									<input
										type="text"
										maxlength="32"
										id="plant-name"
										class="form-control"
										name="plant-name"
										placeholder="Enter plant's name" />
									<div class="has-error hidden" id="hb-plant-name">
										<p class="help-block">
											<b>
												<small>
													Plant name can't be empty, can't contain non-ASCII
													characters and must not be more than 32 characters long.
												</small>
											</b>
										</p>
									</div>
								</div>
							</div>
							<div class="row form-group">
								<label
									class="col-sm-3 control-label"
									for="configuration-password">
									Configuration Password:
								</label>
								<div class="col-sm-5">
									<input
										maxlength="64"
										type="password"
										class="form-control"
										id="configuration-password"
										name="configuration-password"
										placeholder="Password of configuration mode access point" />
									<div
										class="has-error hidden"
										id="hb-configuration-password">
										<p class="help-block">
											<b>
												<small>
													Password can't be empty, can't contain non-ASCII characters
													and must be between 8 and 64 characters long.
												</small>
											</b>
										</p>
									</div>
								</div>
								<div class="checkbox col-sm-2">
									<label>
										<input
											type="checkbox" 
											id="configuration-password-show" />
										Show Characters
									</label>
								</div>
							</div>
							<div class="row form-group">
								<label
									for="wifi-ap"
									class="col-sm-3 control-label">
									WiFi Access Point:
								</label>
								<div class="col-sm-5">
									<select
										class="form-control"
										id="wifi-ap"
										name="wifi-ap">
									</select>
									<div
										class="has-error hidden"
										id="hb-wifi-ap">
										<p class="help-block">
											<b>
												<small>
													A valid WiFi access point must be selected.
												</small>
											</b>
										</p>
									</div>
								</div>
								<div class="col-sm-2 text-left">
									<button
										type="button"
										id="btn-do-wifi-scan"
										class="btn btn-default">
										<span
											aria-hidden="true"
											class="glyphicon glyphicon-search">
										</span>
									</button>
								</div>
							</div>
							<div
								id="row-wifi-ap-info"
								class="row form-group collapse">
								<div class="col-sm-offset-3 col-sm-3">
									<div
										style="font-size:1em;"
										class="glyphicon glyphicon-signal">
									</div>
									<div
										style="display: inline-block;"
										id="wifi-ap-info-signal">
										: -
									</div>&#37;
								</div>
								<div class="col-sm-3">
									<div
										style="font-size:1em;"
										class="glyphicon glyphicon-lock">
									</div>
									<div
										style="display: inline-block;"
										id="wifi-ap-info-authmode">
										: -
									</div>
								</div>
							</div>
							<div
								id="row-wifi-password"
								class="row form-group collapse">
								<label
									class="col-sm-3 control-label"
									for="wifi-ap-password">
									WiFi Password:
								</label>
								<div class="col-sm-5">
									<input
										maxlength="64"
										type="password"
										class="form-control"
										id="wifi-ap-password"
										name="wifi-ap-password"
										placeholder="WiFi password for the access point" />
									<div
										class="has-error hidden"
										id="hb-wifi-ap-password">
										<p class="help-block">
											<b>
												<small>
													Password can't be empty, contain non-ASCII characters
													and be more than 64 characters long.
												</small>
											</b>
										</p>
									</div>
								</div>
								<div class="checkbox col-sm-2">
									<label>
										<input
											type="checkbox"
											id="wifi-ap-password-show" />
										Show Characters
									</label>
								</div>
							</div>
							<div class="row form-group">
								<label
									class="col-sm-3 control-label"
									for="threshold-percent">
									Threshold:
								</label>
								<div class="col-sm-2 text-right">
									Notify when
								</div>
								<div class="col-sm-2">
									<input
										min="1"
										max="100"
										value="0"
										type="number"
										class="form-control text-center"
										id="threshold-percent"
										name="threshold-percent" />
									<div
										class="has-error hidden"
										id="hb-threshold-percent">
										<p class="help-block">
											<b>
												<small>
													Value must be within 1 to 100.
												</small>
											</b>
										</p>
									</div>
								</div>
								<div class="col-sm-5">
									percent
								</div>
							</div>
							<div class="row form-group">
								<div class="col-sm-offset-3 col-sm-2">
									<select
										class="form-control"
										id="threshold-lt-gt"
										name="threshold-lt-gt">
										<option value="1">
											less
										</option>
										<option value="2">
											more
										</option>
									</select>
								</div>
								<div class="col-sm-2 text-center">
									than current moisture
								</div>
								<div class="col-sm-2">
									<input
										readonly
										type="text"
										id="registered-value"
										name="registered-value"
										class="form-control text-center" />
								</div>
								<div class="col-sm-1 text-left">
									<button
										type="button"
										class="btn btn-default"
										id="btn-get-sesnor-reading">
										<span
											aria-hidden="true"
											class="glyphicon glyphicon-refresh">
										</span>
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="panel panel-default">
						<div class="panel-heading">
							<span
								style="font-size:1.5em;"
								class="glyphicon glyphicon-bullhorn">
							</span>
							&nbsp;&nbsp;<font size="3">
											Notifications
										</font>
						</div>
						<div class="panel-body">
							<div class="row form-group">
								<label
									for="notification-email"
									class="col-sm-3 control-label">
									E-mail:
								</label>
								<div class="col-sm-7">
									<input
										type="email"
										maxlength="64"
										class="form-control"
										id="notification-email"
										name="notification-email"
										placeholder="Email address to send notifications to" />
									<div
										class="has-error hidden"
										id="hb-notification-email">
										<p class="help-block">
											<b>
												<small>
													E-mail address can't be empty, can't contain non-ASCII
													characters and must not be more than 254 characters long.
												</small>
											</b>
										</p>
									</div>
								</div>
							</div>
							<div class="row form-group">
								<label
									class="col-sm-3 control-label"
									for="notification-email-subject">
									Subject:
								</label>
								<div class="col-sm-7">
									<input
										type="email"
										maxlength="64"
										class="form-control"
										id="notification-email-subject"
										name="notification-email-subject"
										placeholder="Subject of the notification email" />
									<div
										class="has-error hidden"
										id="hb-notification-email-subject">
										<p class="help-block">
											<b>
												<small>
													Subject can't be empty, must not be more than 64
													characters long and can only contain alphanumeric characters,
													blank spaces, question mark, exclamation mark, hyphen,
													comma and dot.
												</small>
											</b>
										</p>
									</div>
								</div>
							</div>
							<div class="row form-group">
								<label
									class="col-sm-3 control-label"
									for="notification-email-message">
									Message:
								</label>
								<div class="col-sm-7">
									<textarea
										rows="4"
										maxlength="512"
										style="resize:none"
										class="form-control"
										id="notification-email-message"
										name="notification-email-message"
										placeholder="Body of the notification email">
									</textarea>
									<div
										class="has-error hidden"
										id="hb-notification-email-message">
										<p class="help-block">
											<b>
												<small>
													E-mail notification's body can't be empty, must not
													be more than 512 characters long and can only contain
													alphanumeric characters, blank spaces, question mark,
													exclamation mark, hyphen, comma and dot.
												</small>
											</b>
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
				<!-- Config form. -->

				<div class="row">
					<div class="col-sm-6">
						<button
							type="button"
							id="btn-apply"
							class="btn btn-block btn-success btn-default spacer-bottom">
							<span
								aria-hidden="true"
								class="glyphicon glyphicon-ok">
							</span>
							&nbsp;&nbsp;Apply
						</button>
					</div>
					<div class="col-sm-6">
						<button
							type="button"
							id="btn-about"
							class="btn btn-block btn-default spacer-bottom">
								<span
									aria-hidden="true"
									class="glyphicon glyphicon-info-sign">
								</span>
								&nbsp;&nbsp;About
						</button>
					</div>
				</div>
			</div>

			<br/>
			<br/>

			<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
			<script src="js/jquery.min.js"></script>

			<!--
			Include all compiled plugins (below), or include individual files
			as needed
			-->
			<script src="js/bootstrap.min.js"></script>
		</div>
	</body>
</html>

<script type="text/javascript">
	var AUTH_OPEN         = 0;
	var AUTH_WPA_PSK      = 2;
	var AUTH_WPA2_PSK     = 3;
	var AUTH_WPA_WPA2_PSK = 4;

	var JSON_STATUS_OK     = 1;
	var JSON_STATUS_FAILED = 2;

	// Timeouts (milliseconds).
	var TIMEOUT_START_WIFI_SCAN      = 4000;
	var WAIT_WIFI_SCAN_GET_RESULT    = 4000;
	var TIMEOUT_GET_SENSOR_READING   = 4000;
	var TIMEOUT_GET_WIFI_SCAN_RESULT = 4000;
	var TIMEOUT_GENERIC              = 16000;

	var REQUEST_JSON_GET_CONFIG                    = 1;
	var REQUEST_JSON_SAVE_CONFIG                   = 2;
	var WEB_INTERFACE_REQUEST_JSON_START_WIFI_SCAN = 3;
	var WEB_INTERFACE_REQ_JSON_GET_SENSOR_READING  = 4;
	var REQUEST_JSON_GET_WIFI_SCAN_RESULT          = 5;

	var lastReadConfiguration = null;

	// UI element events.
	$('#btn-modal-error-get-config-retry')
		.click(
			function(e) {
				window.location
					.replace(
						window.location.protocol + '//' +
						window.location.hostname + '/'
					);

					window.location.reload(true);
			}
		);

	$('#btn-modal-save-config-retry')
		.click(
			function(e) {
				$('#modal-save-config-header')
					.removeClass('modal-header-danger');

				$('#modal-save-config-header')
					.addClass('modal-header-info');

				$('#modal-save-config-header-title')
					.text('Information');

				$('#modal-save-config-body')
					.text('Saving config...');

				$('#btn-modal-save-config-retry')
					.addClass('hidden');

				$('#btn-modal-save-config-cancel')
					.addClass('hidden');

				$('#modal-save-config')
					.modal('show');

				saveConfig();
			}
		);

	$('#wifi-ap')
		.change(
			function(e) {
				var valuesAP =
					JSON
						.parse($(this).find('option:selected').val());

				// No APs found.
				if(valuesAP == null) {
					$('#row-wifi-ap-info').collapse('hide');
					$('#row-wifi-password').collapse('hide');

					return;
				}

				$('#wifi-ap-info-signal').text(': ' + valuesAP.signal);

				switch(valuesAP.authmode) {
					case AUTH_OPEN:
						$('#wifi-ap-info-authmode').text(': Open');
						$('#row-wifi-password').collapse('hide');

						break;

					case AUTH_WPA_PSK:
						$('#wifi-ap-info-authmode').text(': WPA');
						$('#row-wifi-password').collapse('show');

						break;

					case AUTH_WPA2_PSK:
						$('#wifi-ap-info-authmode').text(': WPA2');
						$('#row-wifi-password').collapse('show');

						break;

					case AUTH_WPA_WPA2_PSK:
						$('#wifi-ap-info-authmode').text(': WPA/WPA2');
						$('#row-wifi-password').collapse('show');

						break;

					default:
						$('#wifi-ap-info-authmode').text(': Unsupported');
						$('#row-wifi-password').collapse('hide');

						break;
				}
			}
		);

	$('#configuration-password-show')
		.change(
			function(e) {
				if(this.checked) {
					$('#configuration-password')
						.attr('type', 'text');
				}
				else {
					$('#configuration-password')
						.attr('type', 'password');
				}
			}
		);

	$('#btn-do-wifi-scan')
		.click(function(e) {
			$('#modal-information-wifi-scan').modal('show');

			$.ajax(
				{
					type: 'POST',
					url: '/start_wifi_scan.cgi',
					data: {
						'request': WEB_INTERFACE_REQUEST_JSON_START_WIFI_SCAN,
						'data': null
					},
					dataType: 'json',
					timeout: TIMEOUT_START_WIFI_SCAN,
					success:
						function(data) {
							setTimeout(
								function(e) {
									$.ajax(
										{
											type: 'POST',
											url: '/get_wifi_scan_result.cgi',
											data: {
												'request': REQUEST_JSON_GET_WIFI_SCAN_RESULT,
												'data': null
											},
											dataType: 'json',
											timeout: TIMEOUT_GET_WIFI_SCAN_RESULT,
											success:
												function(data) {
													$('#modal-information-wifi-scan').modal('hide');
													doUpdateWiFiAPList(data);
												},
											error:
												function(request, status, error) {
													$('#modal-information-wifi-scan').modal('hide');
													$('#modal-error-wifi-scan').modal('show');
												}
										}
									);
								},
								WAIT_WIFI_SCAN_GET_RESULT
							);
						},
					error:
						function(request, status, error) {
							$('#modal-information-wifi-scan').modal('hide');
							$('#modal-error-wifi-scan').modal('show');
						}
				}
			);
		}
	);

	$('#wifi-ap-password-show')
		.change(function(e) {
			if(this.checked) {
				$('#wifi-ap-password').attr('type', 'text');
			}
			else {
				$('#wifi-ap-password').attr('type', 'password');
			}
		}
	);

	$('#btn-get-sesnor-reading')
		.click(function(e) {
			$('#registered-value').val('Reading sensor...');
			$('#btn-get-sesnor-reading').prop('disabled', true);

			$.ajax(
				{
					type: 'POST',
					url: '/get_sensor_reading.cgi',
					data: {
						'request': WEB_INTERFACE_REQ_JSON_GET_SENSOR_READING,
						'data': null
					},
					dataType: 'json',
					timeout: TIMEOUT_GET_SENSOR_READING,
					success:
						function(data) {
							$('#btn-get-sesnor-reading').prop('disabled', false);

							var _data = JSON.parse(JSON.stringify(data));

							if(
								(_data.request === WEB_INTERFACE_REQ_JSON_GET_SENSOR_READING) &&
								(_data.status === JSON_STATUS_OK)
							)
							{
								$('#registered-value').val(String(_data.data));
							}
							else {
								$('#registered-value').val('Error. Try again...');
							}
						},
					error:
						function(request, status, error) {
							$('#btn-get-sesnor-reading').prop('disabled', false);
							$('#registered-value').val('Error. Try again...');
						}
				}
			);
		}
	);

	$('#btn-apply')
		.click(
			function(e) {
				if(doVerify()) {
					$('#modal-save-config-header')
						.removeClass('modal-header-danger');

					$('#modal-save-config-header')
						.addClass('modal-header-info');

					$('#modal-save-config-header-title')
						.text('Information');

					$('#modal-save-config-body')
						.text('Saving config...');

					$('#btn-modal-save-config-retry')
						.addClass('hidden');

					$('#btn-modal-save-config-cancel')
						.addClass('hidden');

					$('#modal-save-config')
						.modal('show');

					saveConfig();
				}
				else {
					$('#modal-error-verification-failed').modal('show');
				}
			}
		);

	$('#btn-about')
		.click(
			function(e) {
				$('#modal-infomation-about').modal('show');
			}
		);

	// Functions.
	function isASCII(stringCheck) {
		return /^[\x00-\x7F]*$/.test(stringCheck);
	}

	function doUpdateWiFiAPList(data) {
		var option = null;
		var _data = JSON.parse(JSON.stringify(data));

		$('#wifi-ap').empty();

		_data.data
			.forEach(
				function(entry) {
					option =
						new Option(
							entry.ssid,
							'{"ssid":"' +
							entry.ssid +
							'", "bssid":"' +
							entry.bssid +
							'", "signal":' +
							Math.min(Math.max(2 * (entry.rssi + 100), 0), 100) +
							', "authmode":' +
							entry.authmode +
							'}'
						);

					$('#wifi-ap').append(option);
				}
			);

		doUpdateWiFiAPListGUI();
	}

	function doVerify() {
		var verified = true;
		var plantName = $('#plant-name').val();
		var thresholdLTGT = $('#threshold-lt-gt').val();
		var wifiAPSSID = $('#wifi-ap option:selected').text();
		var wifiAPPassword = $('#wifi-ap-password').val();
		var registeredValue = $('#registered-value').val();
		var thresholdPercent = $('#threshold-percent').val();
		var notificationEmail = $('#notification-email').val();
		var configurationPassword = $('#configuration-password').val();
		var notificationEmailMessage = $('#notification-email-message').val();
		var notificationEmailSubject = $('#notification-email-subject').val();

		if(plantName.length < 1 || !isASCII(plantName)) {
			verified = false;

			$('#hb-plant-name').removeClass('hidden');
		}
		else {
			$('#hb-plant-name').addClass('hidden');
		}

		if(
			(configurationPassword.length < 8) ||
			(!isASCII(configurationPassword))
		)
		{
			verified = false;

			$('#hb-configuration-password').removeClass('hidden');
		}
		else {
			$('#hb-configuration-password').addClass('hidden');
		}

		if(
			(wifiAPSSID.length < 1) ||
			(wifiAPSSID.length > 32) ||
			(!isASCII(wifiAPSSID)) ||
			($('#wifi-ap option:selected').val() === null)
		)
		{
			verified = false;

			$('#hb-wifi-ap').removeClass('hidden');
		}
		else {
			$('#hb-wifi-ap').addClass('hidden');
		}

		if(
			($('#wifi-ap option:selected').val() !== null) &&
			(JSON.parse($('#wifi-ap option:selected').val()).authmode !== AUTH_OPEN)
		)
		{
			if((wifiAPPassword.length < 1) || (!isASCII(wifiAPPassword))) {
				verified = false;

				$('#hb-wifi-ap-password').removeClass('hidden');
			}
			else {
				$('#hb-wifi-ap-password').addClass('hidden');
			}
		}

		if((thresholdPercent < 1) || (thresholdPercent > 100)) {
			verified = false;

			$('#hb-threshold-percent').removeClass('hidden');
		}
		else {
			$('#hb-threshold-percent').addClass('hidden');
		}

		// TODO: Add more detailed e-mail address check.
		if(
			(notificationEmail.length < 1) ||
			(!isASCII(notificationEmail)) ||
			(!notificationEmail
				.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/))
		)
		{
			verified = false;

			$('#hb-notification-email').removeClass('hidden');
		}
		else {
			$('#hb-notification-email').addClass('hidden');
		}

		if(
			(notificationEmailSubject.length < 1) ||
			(!notificationEmailSubject.match(/^[a-zA-Z0-9 .,!?-]+$/))
		)
		{
			verified = false;

			$('#hb-notification-email-subject').removeClass('hidden');
		}
		else {
			$('#hb-notification-email-subject').addClass('hidden');
		}

		if(
			(notificationEmailMessage.length < 1) ||
			(notificationEmailMessage.length > 512) ||
			(!notificationEmailMessage.match(/^[a-zA-Z0-9 .,!?-]+$/))
		)
		{
			verified = false;

			$('#hb-notification-email-message').removeClass('hidden');
		}
		else {
			$('#hb-notification-email-message').addClass('hidden');
		}

		return verified;
	}

	function doUpdateWiFiAPListGUI() {
		if($('#wifi-ap option').size() > 0) {
			$('#wifi-ap').prop('disabled', false);
			$('#wifi-ap').prop('selectedIndex', 0);
			$('#wifi-ap').change();
			$('#row-wifi-ap-info').collapse('show');
			$('#row-wifi-password').collapse('show');

			if(lastReadConfiguration.config_wifi_ap_bssid) {
				$("#wifi-ap option")
					.each(
						function(index, option) {
							if(JSON.parse(option.value).bssid != lastReadConfiguration.config_wifi_ap_bssid) {
								return true;
							}

							$("#wifi-ap").prop('selectedIndex', index);
							$("#wifi-ap").change();

							return false;
						}
					);
			}
		}
		else {
			$('#wifi-ap').empty();
			$('#wifi-ap')
				.append(
					new Option(
						'No APs found. Scan again?',
						null
					)
				);
			$('#wifi-ap').change();
			$('#wifi-ap').prop('disabled', 'disabled');
			$('#row-wifi-ap-info').collapse('hide');
			$('#row-wifi-password').collapse('hide');
		}
	}

	function updateConfigGUI(data, scanData) {
		if(data) {
			lastReadConfiguration = data;
		}
		else {
			lastReadConfiguration = null;
		}

		doUpdateWiFiAPList(scanData);

		$('#plant-name').val(data.plant_name);
		$('#threshold-lt-gt').val(data.threshold_lt_gt);
		$('#wifi-ap-password').val(data.wifi_ap_password);
		$('#registered-value').val(data.registered_value);
		$('#threshold-percent').val(data.threshold_percent);
		$('#notification-email').val(data.notification_email);
		$('#configuration-password').val(data.configuration_password);
		$('#notification-email-subject').val(data.notification_email_subject);
		$('#notification-email-message').val(data.notification_email_message);
	}

	function getConfig() {
		$.ajax(
			{
				type: 'POST',
				url: '/start_wifi_scan.cgi',
				data: {
					'request': WEB_INTERFACE_REQUEST_JSON_START_WIFI_SCAN,
					'data': null
				},
				dataType: 'json',
				timeout: TIMEOUT_START_WIFI_SCAN,
				success:
					function(data) {
						setTimeout(function(e) {
							$.ajax(
								{
									type: 'POST',
									url: '/get_wifi_scan_result.cgi',
									data: {
										'request': REQUEST_JSON_GET_WIFI_SCAN_RESULT,
										'data': null
									},
									dataType: 'json',
									timeout: TIMEOUT_GET_WIFI_SCAN_RESULT,
									success:
										function(data) {
											var scanData = data;

											$.ajax(
												{
													type: 'POST',
													url: '/get_config.cgi',
													data: {
														'request': REQUEST_JSON_GET_CONFIG,
														'data': null
													},
													dataType: 'json',
													timeout: TIMEOUT_GENERIC,
													success:
														function(data) {
															var _data = JSON.parse(JSON.stringify(data));

															if(
																(_data.request === REQUEST_JSON_GET_CONFIG) &&
																(_data.status === JSON_STATUS_OK)
															)
															{
																updateConfigGUI(_data.data, scanData);
																$('#div-main').removeClass('hidden');
															}
															else {
																$('#modal-error-get-config').modal('show');
															}
														},
													error:
														function(request, status, error) {
															$('#modal-error-get-config').modal('show');
														}
												}
											);
										},
									error:
										function(request, status, error) {
											$('#modal-error-get-config').modal('show');
										}
								}
							);
						},
						4000);
					},
				error:
					function(request, status, error) {
						$('#modal-error-get-config').modal('show');
					}
			}
		);
	}

	function saveConfig() {
		var currentConfig =
			{
				"plantName":
					$('#plant-name').val(),

				"configurationPassword":
					$('#configuration-password').val(),

				"wifiAPSSID":
					$("#wifi-ap option:selected").text(),

				"wifiAPBSSID":
					JSON
						.parse($('#wifi-ap option:selected').val())
							.bssid,

				"wifiAPPassword":
					$('#wifi-ap-password').val(),

				"thresholdPercent":
					$('#threshold-percent').val(),

				"thresholdLTGT":
					$('#threshold-lt-gt').val(),

				"registeredValue":
					$('#registered-value').val(),

				"notificationEmail":
					$('#notification-email').val(),

				"notificationEmailSubject":
					$('#notification-email-subject').val(),

				"notificationEmailMessage":
					$('#notification-email-message').val()
			};

		var dataJSON = JSON.stringify(currentConfig);

		$.ajax(
			{
				type: 'POST',
				url: '/save_config.cgi',
				data: {
					'request': REQUEST_JSON_SAVE_CONFIG,
					'data_json': dataJSON,
					'data_json_len': dataJSON.length
				},
				dataType: 'json',
				timeout: TIMEOUT_GENERIC,
				success:
					function(data) {
						data = JSON.parse(JSON.stringify(data));

						if(
							(data.request == REQUEST_JSON_SAVE_CONFIG) &&
							(data.status == JSON_STATUS_OK)
						 )
						 {
							$('#modal-save-config-header').removeClass('modal-header-danger');
							$('#modal-save-config-header').addClass('modal-header-info');
							$('#modal-save-config-header-title').text('Information');
							$('#modal-save-config-body').text('Config saved. The device will reset.');
							$('#btn-modal-save-config-retry').addClass('hidden');
							$('#btn-modal-save-config-cancel').addClass('hidden');
							$('#modal-save-config').modal('show');
						}
						else {
							$('#modal-save-config-header').removeClass('modal-header-info');
							$('#modal-save-config-header').addClass('modal-header-danger');
							$('#modal-save-config-header-title').text('Error');
							$('#modal-save-config-body').text('Saving config failed. Retry?');
							$('#btn-modal-save-config-retry').removeClass('hidden');
							$('#btn-modal-save-config-cancel').removeClass('hidden');
							$('#modal-save-config').modal('show');
						}
					},
				error:
					function(request, status, error) {
						$('#modal-save-config-header').removeClass('modal-header-info');
						$('#modal-save-config-header').addClass('modal-header-danger');
						$('#modal-save-config-header-title').text('Error');
						$('#modal-save-config-body').text('Saving config failed. Retry?');
						$('#btn-modal-save-config-retry').removeClass('hidden');
						$('#btn-modal-save-config-cancel').removeClass('hidden');
						$('#modal-save-config').modal('show');
					}
			}
		);
	}

	$(document)
		.ready(
			function(e) {
				getConfig();
			}
		);
</script>
